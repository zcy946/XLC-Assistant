## ğŸ“ƒTODO List

### å¸¸è§„

- [x] åˆ†ç¦»McpServeråˆ°å•ç‹¬çš„ç±»
- [x] ä»MCPServer.jsonæ–‡ä»¶ä¸­åŠ è½½mcpæœåŠ¡å™¨
- [x] æ›´æ–°MCPServer.jsonæ–‡ä»¶
- [x] ä»Agents.jsonæ–‡ä»¶ä¸­åŠ è½½agent
- [x] æ›´æ–°Agents.jsonæ–‡ä»¶
- [x] ä»DataManagerä¸­**å¼‚æ­¥**è¯»å–mcpæœåŠ¡å™¨å’Œagentå¹¶æ¸²æŸ“
- [x] å®ç°Agentsè®¾ç½®ç•Œé¢å¢åˆ æŒ‚è½½çš„mcpæœåŠ¡å™¨
- [x] å°è£…mcpclientä¸ºmcpç½‘å…³ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†mcpæœåŠ¡å™¨
- [x] åˆ›å»ºLLMServiceç±»ç”¨äºä¸åŒçš„Agentå’ŒMcpç½‘å…³äº¤äº’
- [x] æŠ½è±¡å‡ºModelç±»ç”¨äºç®¡ç†æ¨¡å‹
- [x] å°†Agentçš„McpServersæ”¹ä¸ºç”¨QSetå­˜å‚¨
- [x] å®ç°è°ƒç”¨LLMå¯¹è¯
- [x] ä¿®å¤æ— `tools`æ—¶ï¼Œç¨‹åºæŠ¥é”™çš„bug
- [x] è§£æLLMçš„å“åº”å®ç°å·¥å…·è°ƒç”¨
- [x] ä¿®å¤Agentè®¾ç½®é¡µï¼ŒllmComboBoxæœªé€‰ä¸­çœŸå®é¡¹çš„bug
- [ ] ä¿®å¤é…ç½®åŠ è½½å‰æœªå¤‡ä»½å¯¼è‡´å†…å­˜è¢«æ›¿æ¢çš„bug (å¿˜è®°æ˜¯ä»€ä¹ˆäº†ğŸ˜…(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»*))
- [x] ä¿®å¤è®¾ç½®ç•Œé¢æ›´æ–°Agent/mcpæœåŠ¡å™¨/æ¨¡å‹ålistwidgetä¸­çš„itemæœªè¢«åˆ·æ–°çš„bug
- [x] å®ç°è®¾ç½®ç•Œé¢æ·»åŠ Agentã€McpæœåŠ¡å™¨ã€LLM
- [x] å®ç°åˆ é™¤Agentã€McpæœåŠ¡å™¨ã€LLM
- [x] å®ç°è®¾ç½®-åŠ©æ‰‹-å¯¹è¯åˆ—è¡¨å³é”®çš„è·³è½¬å±•ç¤ºåŠŸèƒ½
- [x] ä¿®å¤æ·»åŠ æ–°LLM|æ›´æ–°LLMä¿¡æ¯æ—¶ï¼Œç‚¹å‡»è®¾ç½®-åŠ©æ‰‹è®¾ç½®-æ¨¡å‹çš„comboboxåˆ—è¡¨æ²¡æœ‰æ›´æ–°çš„bug
- [x] ä¸ºmcpserverç»“æ„ä½“æ·»åŠ `isActive`ä»£è¡¨æ˜¯å¦å¯ç”¨
- [ ] ä½¿ç”¨`QListView`é‡æ„ç®€å•çš„æ¶ˆæ¯åˆ—è¡¨
- [ ] å®ç°æ¸…é™¤ä¸Šä¸‹æ–‡ã€æ–°å»ºå¯¹è¯
- [ ] å®ç°å³é”®åŠ©æ‰‹åˆ—è¡¨å¼¹å‡ºèœå•ï¼ˆç¼–è¾‘ï¼‰
- [ ] å®ç°è°ƒç”¨ç»“æœçš„å±•ç¤º
- [x] åŠ è½½jsoné…ç½®æ–‡ä»¶æ—¶ï¼Œå¦‚æœä¸ºç©ºä¼šå¯¼è‡´è§¦å‘assert

### ä¼˜åŒ–

- [ ] å°†å­˜å‚¨è®¾ç½®æ”¹ä¸ºå¸¸è§„è®¾ç½®ï¼Œåˆ›å»º`config.json`ç®¡ç†`LLMs.json`ã€`Agents.json`ã€`McpServers.json`çš„å­˜å‚¨ä½ç½®ä»¥åŠæ˜¯å¦ä½¿ç”¨mcpæœåŠ¡å™¨ç­‰å‚æ•°
- [ ] ä¿®æ”¹mcpæœåŠ¡å™¨è®¾ç½®é¡µï¼Œå®ç°è‡ªå®šä¹‰å¯åœmcpæœåŠ¡å™¨ï¼Œä»è€Œé™ä½å®¢æˆ·ç«¯åˆå§‹åŒ–çš„å‹åŠ›
- [ ] ä¼˜åŒ–å¼‚å¸¸å±•ç¤º
- [ ] åœ¨å„ä¸ª`getCurrentData`å‡½æ•°å†…éƒ¨åˆ¤ç©º
- [x] å°†`LLMService`å’Œ`McpGateway`ä½œä¸ºå•ä¾‹å®ç°
- [ ] ä¸º`Conversation`ç»“æ„ä½“çš„`messages`ç›¸å…³æ“ä½œåŠ é”

### **è¿›é˜¶**

- [ ] ä»æ•°æ®åº“åŠ è½½å¯¹è¯æ•°æ®
- [ ] ä½¿ç”¨QListViewåˆ¶ä½œæ¶ˆæ¯åˆ—è¡¨æ§ä»¶



## Note

å…³äºå®ç°mcpæœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆ`initClient`å‡½æ•°ï¼‰çš„ç›¸å…³æ€è·¯ï¼š

- **å½“æŸä¸ªæœåŠ¡å™¨è¢«è°ƒç”¨æ—¶ï¼š**æ£€æŸ¥æ˜¯å¦å­˜åœ¨å·²ç»è¢«æ¿€æ´»çš„mcpæœåŠ¡å™¨ã€‚å¦‚æœæ²¡æœ‰å°±å°†æ­¤mcpæœåŠ¡å™¨çš„idå­˜å…¥`pendingClients`ä¸­ï¼Œç„¶åä½¿ç”¨QtConcurrenté…åˆQFutureWatcherå¯¹æ­¤mcpæœåŠ¡å™¨è¿›è¡Œåˆå§‹åŒ–ï¼ˆå…·ä½“ç»†èŠ‚ä¸ºï¼šåœ¨QtConcurrentä¸­åˆå§‹åŒ–clientå¹¶å°†clientå­˜å…¥McpServiceçš„clientå®¹å™¨ä¸­ï¼Œåœ¨QFutureWatcherçš„finishedæ§½ä¸­å°†è¯¥mcpæœåŠ¡å™¨çš„idä»`pendingClients`å‰”é™¤ï¼‰ã€‚ï¼ˆpendingClientsçš„ç»“æ„`QMap<QString, QFuture<MCPClient*>> pendingClients;  `ï¼‰

- **ç”¨æˆ·æ·»åŠ mcpæœåŠ¡å™¨æ—¶ï¼š**å½“ç”¨æˆ·æ·»åŠ äº†æ–°çš„mcpæœåŠ¡å™¨åï¼Œæ‰§è¡ŒmcpæœåŠ¡å™¨åˆå§‹åŒ–ç›¸å…³æµç¨‹ã€‚
- **ç”¨æˆ·æŒ‚è½½mcpæœåŠ¡å™¨æ—¶ï¼š**å½“ç”¨æˆ·åœ¨èŠå¤©é¡µé¢æŒ‚è½½äº†mcpæœåŠ¡å™¨åï¼Œæ£€æŸ¥è¯¥mcpæœåŠ¡å™¨æ˜¯å¦å·²ç»è¢«åˆå§‹åŒ–ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ£€æŸ¥è¯¥æœåŠ¡å™¨idæ˜¯å¦å­˜åœ¨äº`pendingClients`åˆ—è¡¨ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœæ²¡æœ‰è¢«åˆå§‹åŒ–åˆ™æ‰§è¡Œåˆå§‹åŒ–ç›¸å…³æµç¨‹ã€‚
- **ç”¨æˆ·è·å–mcpæœåŠ¡å™¨å·¥å…·åˆ—è¡¨æˆ–è€…å…¶ä»–ä¿¡æ¯æ—¶ï¼š**æ ¹æ®æƒ…å†µåˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹ç›¸å…³mcpæœåŠ¡å™¨è¿›è¡Œåˆå§‹åŒ–ã€‚
- **åœ¨è‡ªåŠ¨æ£€æŸ¥mcpæœåŠ¡å™¨æ˜¯å¦å­˜æ´»ç›¸å…³çº¿ç¨‹ä¸­ï¼š**å¦‚æœå­˜åœ¨mcpæœåŠ¡å™¨ä¿æ´»ç›¸å…³åŠŸèƒ½ï¼Œåˆ™åº”è¯¥åœ¨ä¾‹å¦‚pingäº†æœåŠ¡å™¨åæ ¹æ®æƒ…å†µæ‰§è¡ŒmcpæœåŠ¡å™¨åˆå§‹åŒ–æµç¨‹ã€‚

**æœ€å¥½åœ¨QtConcurrentä¸­è°ƒç”¨`initClient`å‡½æ•°ï¼ï¼ï¼**ï¼ˆåˆ¤æ–­è¿”å›çš„futureæ˜¯å¦ä¸ºç©ºï¼Œï¼‰

## QFuture å¹¶å‘æ§åˆ¶æœºåˆ¶è§£é‡Š

`QMap<QString, QFuture<MCPClient*>> pendingClients` çš„å·¥ä½œåŸç†ç±»ä¼¼äº Cherry Studio ä¸­çš„ Promise æœºåˆ¶ï¼š MCPService.ts:137

### è¿ä½œåŸç†ï¼š

1. **å­˜å‚¨å¼‚æ­¥æ“ä½œ**ï¼š`QFuture` ä»£è¡¨ä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„å¼‚æ­¥åˆå§‹åŒ–æ“ä½œ
2. **é˜²æ­¢é‡å¤åˆå§‹åŒ–**ï¼šå½“å¤šä¸ªè¯·æ±‚åŒæ—¶éœ€è¦åŒä¸€æœåŠ¡å™¨æ—¶ï¼š

```c++
QFuture<MCPClient*> MCPService::initClient(const MCPServer& server) {  
    QString serverKey = getServerKey(server);  
      
    // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ­£åœ¨è¿›è¡Œçš„åˆå§‹åŒ–  
    if (pendingClients.contains(serverKey)) {  
        return pendingClients[serverKey]; // è¿”å›åŒä¸€ä¸ª QFuture  
    }  
      
    // å¼€å§‹æ–°çš„å¼‚æ­¥åˆå§‹åŒ–  
    QFuture<MCPClient*> future = QtConcurrent::run([this, server]() {  
        return createMCPClient(server);  
    });  
      
    // å­˜å‚¨ QFuture ä¾›å…¶ä»–å¹¶å‘è¯·æ±‚ä½¿ç”¨  
    pendingClients[serverKey] = future;  
      
    // å®Œæˆåæ¸…ç†  
    QFutureWatcher<MCPClient*>* watcher = new QFutureWatcher<MCPClient*>;  
    connect(watcher, &QFutureWatcher<MCPClient*>::finished, [this, serverKey, watcher]() {  
        pendingClients.remove(serverKey);  
        watcher->deleteLater();  
    });  
    watcher->setFuture(future);  
      
    return future;  
}
```

### å¹¶å‘åœºæ™¯ç¤ºä¾‹ï¼š

- **è¯·æ±‚ A**ï¼šè°ƒç”¨ `initClient(server1)`ï¼Œåˆ›å»º QFuture å¹¶å­˜å‚¨
- **è¯·æ±‚ B**ï¼šåŒæ—¶è°ƒç”¨ `initClient(server1)`ï¼Œå‘ç°å·²æœ‰ QFutureï¼Œç›´æ¥è¿”å›
- **ç»“æœ**ï¼šä¸¤ä¸ªè¯·æ±‚ç­‰å¾…åŒä¸€ä¸ªåˆå§‹åŒ–è¿‡ç¨‹ï¼Œé¿å…é‡å¤è¿æ¥

è¿™ç§æœºåˆ¶ç¡®ä¿äº†å³ä½¿å¤šä¸ªæ“ä½œåŒæ—¶éœ€è¦åŒä¸€æœåŠ¡å™¨ï¼Œä¹Ÿåªä¼šè¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–ï¼Œç±»ä¼¼äº Cherry Studio çš„å®ç°ã€‚

## closeClient å‡½æ•°çš„è°ƒç”¨æ—¶æœº

### 1. æœåŠ¡å™¨ç§»é™¤æ—¶

å½“ç”¨æˆ·åˆ é™¤ MCP æœåŠ¡å™¨é…ç½®æ—¶ï¼Œ`removeServer` æ–¹æ³•ä¼šå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æ´»è·ƒçš„å®¢æˆ·ç«¯è¿æ¥ï¼Œå¦‚æœå­˜åœ¨åˆ™è°ƒç”¨ `closeClient` è¿›è¡Œæ¸…ç†ã€‚

### 3. è¿æ¥æ£€æŸ¥å¤±è´¥æ—¶

åœ¨ `checkMcpConnectivity` æ–¹æ³•ä¸­ï¼Œå¦‚æœè¿æ¥æ£€æŸ¥å¤±è´¥ï¼Œä¼šè°ƒç”¨ `closeClient` ç¡®ä¿å®¢æˆ·ç«¯çŠ¶æ€æ¸…æ´ã€‚

### 4. åº”ç”¨ç¨‹åºæ¸…ç†æ—¶

åœ¨åº”ç”¨ç¨‹åºé€€å‡ºè¿‡ç¨‹ä¸­ï¼Œ`cleanup` æ–¹æ³•ä¼šéå†æ‰€æœ‰å®¢æˆ·ç«¯å¹¶è°ƒç”¨ `closeClient` è¿›è¡Œèµ„æºæ¸…ç†ã€‚

è¿™ä¸ª `cleanup` æ–¹æ³•åœ¨åº”ç”¨ç¨‹åºçš„ `will-quit` äº‹ä»¶ä¸­è¢«è°ƒç”¨ã€‚



## `sse_client`ç±»ä¸­éœ€è¦`try-catch`åŒ…è£¹çš„ public å‡½æ•°

### 1. åˆå§‹åŒ–ç›¸å…³å‡½æ•°

**`initialize()`** - åˆå§‹åŒ–å®¢æˆ·ç«¯è¿æ¥ mcp_sse_client.cpp:53-114

- å¯èƒ½æŠ›å‡º `std::runtime_error`ï¼ˆSSE è¿æ¥å¤±è´¥ã€è¶…æ—¶ç­‰ï¼‰

### 2. è¯·æ±‚å‘é€å‡½æ•°

**`send_request()`** - å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº” mcp_sse_client.h:104-106

- å†…éƒ¨è°ƒç”¨ `send_jsonrpc()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception`

**`send_notification()`** - å‘é€é€šçŸ¥æ¶ˆæ¯ mcp_sse_client.h:112-114

- åŒæ ·è°ƒç”¨ `send_jsonrpc()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception`

### 3. å·¥å…·ç›¸å…³å‡½æ•°

**`call_tool()`** - è°ƒç”¨æœåŠ¡å™¨å·¥å…· mcp_sse_client.h:128-130

- å†…éƒ¨è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:186-191

**`get_tools()`** - è·å–å¯ç”¨å·¥å…·åˆ—è¡¨ mcp_sse_client.h:135-137

- å†…éƒ¨è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:193-219

### 4. èµ„æºç›¸å…³å‡½æ•°

**`list_resources()`** - åˆ—å‡ºå¯ç”¨èµ„æº mcp_sse_client.h:149-150

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:225-231

**`read_resource()`** - è¯»å–èµ„æºå†…å®¹ mcp_sse_client.h:155-157

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:233-237

**`subscribe_to_resource()`** - è®¢é˜…èµ„æºå˜æ›´ mcp_sse_client.h:162-164

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:239-243

**`list_resource_templates()`** - åˆ—å‡ºèµ„æºæ¨¡æ¿ mcp_sse_client.h:168-170

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:245-247

### 5. æœåŠ¡å™¨èƒ½åŠ›å‡½æ•°

**`get_server_capabilities()`** - è·å–æœåŠ¡å™¨èƒ½åŠ› mcp_sse_client.h:119-121

- è™½ç„¶åªæ˜¯è¿”å›ç¼“å­˜å€¼ï¼Œä½†å¦‚æœåœ¨åˆå§‹åŒ–å¤±è´¥åè°ƒç”¨å¯èƒ½è¿”å›ç©ºå€¼
