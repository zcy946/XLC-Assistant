## ğŸ“ƒTODO List

### å¸¸è§„

- [x] åˆ†ç¦»McpServeråˆ°å•ç‹¬çš„ç±»
- [x] ä»MCPServer.jsonæ–‡ä»¶ä¸­åŠ è½½mcpæœåŠ¡å™¨
- [x] æ›´æ–°MCPServer.jsonæ–‡ä»¶
- [x] ä»Agents.jsonæ–‡ä»¶ä¸­åŠ è½½agent
- [x] æ›´æ–°Agents.jsonæ–‡ä»¶
- [x] ä»DataManagerä¸­**å¼‚æ­¥**è¯»å–mcpæœåŠ¡å™¨å’Œagentå¹¶æ¸²æŸ“
- [x] å®ç°Agentsè®¾ç½®ç•Œé¢å¢åˆ æŒ‚è½½çš„mcpæœåŠ¡å™¨
- [x] å°è£…mcpclientä¸ºmcpç½‘å…³ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†mcpæœåŠ¡å™¨
- [x] åˆ›å»ºLLMServiceç±»ç”¨äºä¸åŒçš„Agentå’ŒMcpç½‘å…³äº¤äº’
- [x] æŠ½è±¡å‡ºModelç±»ç”¨äºç®¡ç†æ¨¡å‹
- [x] å°†Agentçš„McpServersæ”¹ä¸ºç”¨QSetå­˜å‚¨
- [x] å®ç°è°ƒç”¨LLMå¯¹è¯
- [x] ä¿®å¤æ— `tools`æ—¶ï¼Œç¨‹åºæŠ¥é”™çš„bug
- [x] è§£æLLMçš„å“åº”å®ç°å·¥å…·è°ƒç”¨
- [x] ä¿®å¤Agentè®¾ç½®é¡µï¼ŒllmComboBoxæœªé€‰ä¸­çœŸå®é¡¹çš„bug
- [ ] ä¿®å¤é…ç½®åŠ è½½å‰æœªå¤‡ä»½å¯¼è‡´å†…å­˜è¢«æ›¿æ¢çš„bug (å¿˜è®°æ˜¯ä»€ä¹ˆäº†ğŸ˜…(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»(ãƒ»âˆ€ãƒ»*))
- [x] ä¿®å¤è®¾ç½®ç•Œé¢æ›´æ–°Agent/mcpæœåŠ¡å™¨/æ¨¡å‹ålistwidgetä¸­çš„itemæœªè¢«åˆ·æ–°çš„bug
- [x] å®ç°è®¾ç½®ç•Œé¢æ·»åŠ Agentã€McpæœåŠ¡å™¨ã€LLM
- [x] å®ç°åˆ é™¤Agentã€McpæœåŠ¡å™¨ã€LLM
- [x] å®ç°è®¾ç½®-åŠ©æ‰‹-å¯¹è¯åˆ—è¡¨å³é”®çš„è·³è½¬å±•ç¤ºåŠŸèƒ½
- [x] ä¿®å¤æ·»åŠ æ–°LLM|æ›´æ–°LLMä¿¡æ¯æ—¶ï¼Œç‚¹å‡»è®¾ç½®-åŠ©æ‰‹è®¾ç½®-æ¨¡å‹çš„comboboxåˆ—è¡¨æ²¡æœ‰æ›´æ–°çš„bug
- [x] ä¸ºmcpserverç»“æ„ä½“æ·»åŠ `isActive`ä»£è¡¨æ˜¯å¦å¯ç”¨
- [x] å®ç°æ¸…é™¤ä¸Šä¸‹æ–‡
- [x] ä½¿ç”¨`QListView`é‡æ„ç®€å•çš„æ¶ˆæ¯åˆ—è¡¨
- [x] å®ç°æ–°å»ºå¯¹è¯
- [ ] å®ç°å³é”®åŠ©æ‰‹åˆ—è¡¨å¼¹å‡ºèœå•ï¼ˆç¼–è¾‘ï¼‰
- [x] å®ç°è°ƒç”¨ç»“æœçš„å±•ç¤º
- [x] åŠ è½½jsoné…ç½®æ–‡ä»¶æ—¶ï¼Œå¦‚æœä¸ºç©ºä¼šå¯¼è‡´è§¦å‘assert

### ä¼˜åŒ–

- [ ] å°†å­˜å‚¨è®¾ç½®æ”¹ä¸ºå¸¸è§„è®¾ç½®ï¼Œåˆ›å»º`config.json`ç®¡ç†`LLMs.json`ã€`Agents.json`ã€`McpServers.json`çš„å­˜å‚¨ä½ç½®ä»¥åŠæ˜¯å¦ä½¿ç”¨mcpæœåŠ¡å™¨ç­‰å‚æ•°
- [x] ä¿®æ”¹mcpæœåŠ¡å™¨è®¾ç½®é¡µï¼Œå®ç°è‡ªå®šä¹‰å¯åœmcpæœåŠ¡å™¨ï¼Œä»è€Œé™ä½å®¢æˆ·ç«¯åˆå§‹åŒ–çš„å‹åŠ›
- [x] ä¼˜åŒ–å¼‚å¸¸å±•ç¤º(åˆ›å»ºæ¶ˆæ¯å¼¹çª—æ§ä»¶)
- [ ] åœ¨å„ä¸ª`getCurrentData`å‡½æ•°å†…éƒ¨åˆ¤ç©º
- [x] å°†`LLMService`å’Œ`McpGateway`ä½œä¸ºå•ä¾‹å®ç°
- [x] ä¸º`Conversation`ç»“æ„ä½“çš„`messages`ç›¸å…³æ“ä½œåŠ é”
- [ ] å°†æ‰€æœ‰`mcp::json`ç±»å‹æ”¹ä¸º`QJson`
- [ ] ä¸ºå¤§å¤šæ•°ç±»æ·»åŠ ç”¨äºåé¦ˆåˆ°ç•Œé¢çš„æˆåŠŸ|å¤±è´¥çš„ä¿¡å·å’Œæ§½

### **è¿›é˜¶**

- [x] ä»æ•°æ®åº“åŠ è½½å¯¹è¯æ•°æ®
- [x] ä½¿ç”¨QListViewåˆ¶ä½œæ¶ˆæ¯åˆ—è¡¨æ§ä»¶
- [ ] ä½¿ç”¨è™šæ‹ŸåŒ–åˆ—è¡¨ä¼˜åŒ–å†å²æ¶ˆæ¯æ§ä»¶æ€§èƒ½
- [ ] å®ç°æµå¼è¾“å‡º

## ğŸ¤”å®ç°æ€è·¯

### `CMessageManager`

- **ç»“æ„é€»è¾‘ï¼š**æ¯ä¸€ä¸ª`CMessage`éƒ½å†…ç½®ä¸€ä¸ªç”¨äºå€’è®¡æ—¶é€€å‡ºçš„å®šæ—¶å™¨ï¼Œè¯¥å®šæ—¶å™¨ç»“æŸåå°†ç§æœ‰å˜é‡`m_timeoutOccurred`è®¾ç½®ä¸º`true`ï¼Œå¹¶è§¦å‘`sig_requestExit`ä¿¡å·å‘ŠçŸ¥`CMessageManager`æ’­æ”¾åŠ¨ç”»å¹¶æ¸…é™¤è¯¥æ¡æ¶ˆæ¯ï¼›åœ¨`CMessageManager`ä¸­å¤„ç†`sig_requestExit`ä¿¡å·çš„æ§½å‡½æ•°ä¸­ï¼Œå…ˆåˆ¤æ–­å½“å‰æ˜¯å¦æ­£åœ¨æ’­æ”¾åŠ¨ç”»ï¼Œå¦‚æœæ˜¯åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸æ˜¯åˆ™æ£€æŸ¥æ¶ˆæ¯åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¯å¦å·²ç»å€’è®¡æ—¶ç»“æŸï¼Œå¦‚æœä¸æ˜¯åˆ™è¿”å›ï¼Œå¦‚æœæ˜¯åˆ™æ’­æ”¾æ¨å‡ºåŠ¨ç”»ï¼Œå¹¶åœ¨åŠ¨ç”»ç»“æŸåç§»é™¤æ¶ˆæ¯ã€‚ç§»é™¤æ¶ˆæ¯ä¹‹åè¦åˆ¤æ–­æ–°çš„ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¯å¦å·²ç»å€’è®¡æ—¶ç»“æŸï¼Œå¦‚æœç»“æŸåˆ™æ’­æ”¾ç»“æŸåŠ¨ç”»ï¼Œä»¥æ­¤è¿­ä»£ã€‚
- **é€€å‡ºåŠ¨ç”»ï¼š**å½“æ’­æ”¾æ¨å‡ºåŠ¨ç”»æ—¶ï¼Œé™¤äº†è¦æ’­æ”¾å½“å‰æ¶ˆæ¯çš„æ¸å˜æ¶ˆå¤±å’Œç§»å‡ºçª—å£çš„åŠ¨ç”»ï¼Œè¿˜è¦ä¾æ¬¡æ’­æ”¾åˆ—è¡¨ä¸­å‰©ä½™æ¶ˆæ¯ç§»åŠ¨çš„åŠ¨ç”»ã€‚å¯ä»¥é€šè¿‡`QParallelAnimationGroup`ç®¡ç†è¿™äº›åŠ¨ç”»ï¼Œä½¿å…¶åŒæ—¶å¼€å§‹ã€‚

## ğŸ—’ï¸Note

### æ•°æ®åº“è¡¨ç»“æ„

### 1. `conversations` è¡¨

å¯¹åº” `Conversation` ç»“æ„ä½“ï¼š

```sql
CREATE TABLE conversations (
    id TEXT PRIMARY KEY,                 -- ä¼šè¯ID (UUID)
    agent_id TEXT NOT NULL,              -- å…³è”çš„ Agent ID
    summary TEXT,                        -- ä¼šè¯æ‘˜è¦
    created_time TEXT NOT NULL,          -- åˆ›å»ºæ—¶é—´ (ISO 8601 æ ¼å¼: YYYY-MM-DD HH:MM:SS)
    updated_time TEXT NOT NULL,          -- æ›´æ–°æ—¶é—´
);
```

ç´¢å¼•å»ºè®®ï¼š

```sql
CREATE INDEX idx_conversations_agent_id ON conversations(agent_id);
CREATE INDEX idx_conversations_updated_time ON conversations(updated_time);
```

------

### 2. `messages` è¡¨

å¯¹åº” `CMessage` ç»“æ„ä½“ï¼š

```sql
CREATE TABLE messages (
    seq INTEGER PRIMARY KEY AUTOINCREMENT,   -- æ¶ˆæ¯åºå·ï¼Œå”¯ä¸€é€’å¢
    id TEXT UNIQUE NOT NULL,                 -- æ¶ˆæ¯ID (UUID)
    conversation_id TEXT NOT NULL,       -- å…³è”çš„ä¼šè¯ID
    role TEXT NOT NULL CHECK(role IN ('USER', 'ASSISTANT', 'TOOL', 'SYSTEM', 'UNKNOWN')), -- æ¶ˆæ¯è§’è‰²
    content TEXT NOT NULL,                  -- æ¶ˆæ¯å†…å®¹
    created_time TEXT NOT NULL,          -- åˆ›å»ºæ—¶é—´ (ISO 8601)
    avatar_file_path TEXT,               -- å¤´åƒæ–‡ä»¶è·¯å¾„
    tool_calls TEXT,					 -- å½“LLMè°ƒç”¨å·¥å…·æ—¶å­˜åœ¨çš„å­—æ®µ
    tool_call_id TEXT,					 -- å½“å°†MCPServerè¿”å›çš„è°ƒç”¨ç»“æœå‘é€ç»™LLMæ—¶å­˜åœ¨

    FOREIGN KEY(conversation_id) REFERENCES conversations(id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
);
```

ç´¢å¼•å»ºè®®ï¼š

```sql
CREATE INDEX idx_messages_conversation_id ON messages(conversation_id);
CREATE INDEX idx_messages_created_time ON messages(created_time);
```

------

### 3. å…³ç³»è®¾è®¡è¯´æ˜

- `conversations` ä¸ `messages` æ˜¯ **ä¸€å¯¹å¤š**ã€‚
- åˆ é™¤ä¸€ä¸ª `conversation` æ—¶ï¼Œç›¸å…³ `messages` è‡ªåŠ¨åˆ é™¤ï¼ˆ`ON DELETE CASCADE`ï¼‰ã€‚
- `messages.role` ç”¨ **æšä¸¾çº¦æŸ** (`CHECK`) ç¡®ä¿åªå…è®¸ä¸‰ç§å€¼ã€‚
- `created_time`ã€`updated_time` ç”¨ `TEXT` å­˜å‚¨ ISO 8601ï¼Œæ–¹ä¾¿ SQLite å†…ç½®å‡½æ•°æ¯”è¾ƒã€‚

------



## âš ï¸æ³¨æ„äº‹é¡¹

### 1. `ToastManager`çš„è°ƒç”¨æ—¶æœº

`ToastManager`çš„`showMessage`å‡½æ•°ï¼Œä»…èƒ½åœ¨ä¸»ç•Œçº¿ç¨‹ä¸­è°ƒç”¨ï¼Œä¸èƒ½å†å­çº¿ç¨‹ä¸­è°ƒç”¨ã€‚

### 2. `sse_client`ç±»ä¸­éœ€è¦`try-catch`åŒ…è£¹çš„ public å‡½æ•°

1. **åˆå§‹åŒ–ç›¸å…³å‡½æ•°**

**`initialize()`** - åˆå§‹åŒ–å®¢æˆ·ç«¯è¿æ¥ mcp_sse_client.cpp:53-114

- å¯èƒ½æŠ›å‡º `std::runtime_error`ï¼ˆSSE è¿æ¥å¤±è´¥ã€è¶…æ—¶ç­‰ï¼‰

2. **è¯·æ±‚å‘é€å‡½æ•°**

**`send_request()`** - å‘é€è¯·æ±‚å¹¶ç­‰å¾…å“åº” mcp_sse_client.h:104-106

- å†…éƒ¨è°ƒç”¨ `send_jsonrpc()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception`

**`send_notification()`** - å‘é€é€šçŸ¥æ¶ˆæ¯ mcp_sse_client.h:112-114

- åŒæ ·è°ƒç”¨ `send_jsonrpc()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception`

3. **å·¥å…·ç›¸å…³å‡½æ•°**

**`call_tool()`** - è°ƒç”¨æœåŠ¡å™¨å·¥å…· mcp_sse_client.h:128-130

- å†…éƒ¨è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:186-191

**`get_tools()`** - è·å–å¯ç”¨å·¥å…·åˆ—è¡¨ mcp_sse_client.h:135-137

- å†…éƒ¨è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:193-219

4. **èµ„æºç›¸å…³å‡½æ•°**

**`list_resources()`** - åˆ—å‡ºå¯ç”¨èµ„æº mcp_sse_client.h:149-150

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:225-231

**`read_resource()`** - è¯»å–èµ„æºå†…å®¹ mcp_sse_client.h:155-157

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:233-237

**`subscribe_to_resource()`** - è®¢é˜…èµ„æºå˜æ›´ mcp_sse_client.h:162-164

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:239-243

**`list_resource_templates()`** - åˆ—å‡ºèµ„æºæ¨¡æ¿ mcp_sse_client.h:168-170

- è°ƒç”¨ `send_request()`ï¼Œå¯èƒ½æŠ›å‡º `mcp_exception` mcp_sse_client.cpp:245-247

4. **æœåŠ¡å™¨èƒ½åŠ›å‡½æ•°**

**`get_server_capabilities()`** - è·å–æœåŠ¡å™¨èƒ½åŠ› mcp_sse_client.h:119-121

- è™½ç„¶åªæ˜¯è¿”å›ç¼“å­˜å€¼ï¼Œä½†å¦‚æœåœ¨åˆå§‹åŒ–å¤±è´¥åè°ƒç”¨å¯èƒ½è¿”å›ç©ºå€¼



## ğŸ’¾APIæ¥å£

### 1. Agent

#### 1. æˆå‘˜å˜é‡

| å˜é‡             | ç±»å‹      | æè¿°                                          |
| ---------------- | --------- | --------------------------------------------- |
| messages         | mcp::json | æ¶ˆæ¯åˆ—è¡¨                                      |
| tools            | mcp::json | mcpå·¥å…·åˆ—è¡¨                                   |
| max_retries      | int       | æœ€å¤§é‡è¯•æ¬¡æ•°                                  |
| retries_interval | int       | é‡è¯•é—´éš”(å•ä½: ms)                            |
| model            | string    | æ¨¡å‹å                                        |
| max_tokens       | int       | ä¸€æ¬¡è¯·æ±‚ä¸­æ¨¡å‹ç”Ÿæˆ completion çš„æœ€å¤§ token æ•° |
| temperature      | double    | æ¨¡å‹æ¸©åº¦                                      |
| tool_choice      | string    | æ§åˆ¶æ¨¡å‹è°ƒç”¨ tool çš„è¡Œä¸º                      |
| system_prompt    | string    | ç³»ç»Ÿæç¤ºè¯                                    |

#### 2. æˆå‘˜å‡½æ•°

| å‡½æ•°               | æƒé™    | æè¿°                 |
| ------------------ | ------- | -------------------- |
| post               | public  | å‘LLMå‘é€è¯·æ±‚        |
| setSystemPrompt    | public  | è®¾ç½®ç³»ç»Ÿæç¤ºè¯       |
| getSystemPrompt    | public  | è·å–ç³»ç»Ÿæç¤ºè¯       |
| setModel           | public  | è®¾ç½®æ¨¡å‹åç§°         |
| getModel           | public  | è·å–æ¨¡å‹åç§°         |
| setMaxTokens       | public  | è®¾ç½®æœ€å¤§tokenæ•°      |
| getMaxTokens       | public  | è·å–æœ€å¤§tokenæ•°      |
| setTemperature     | public  | è®¾ç½®æ¨¡å‹æ¸©åº¦         |
| getTemperature     | public  | è·å–æ¨¡å‹æ¸©åº¦         |
| setToolChoice      | public  | è®¾ç½®æ¨¡å‹toolè°ƒç”¨è¡Œä¸º |
| getToolChoice      | public  | è·å–æ¨¡å‹toolè°ƒç”¨è¡Œæ–‡ |
| getMessages        | public  | è·å–æ‰€æœ‰æ¶ˆæ¯         |
| getLastMessage     | public  | è·å–æœ€åä¸€æ¡æ¶ˆæ¯     |
| setMaxRetries      | public  | è®¾ç½®è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•° |
| getMaxRetries      | public  | è·å–è¯·æ±‚æœ€å¤§é‡è¯•æ¬¡æ•° |
| setRetriesInterval | public  | è®¾ç½®é‡è¯•é—´éš”         |
| getRetriesInterval | public  | è·å–é‡è¯•é—´éš”         |
| getTools           | private | è·å–å·¥å…·åˆ—è¡¨         |
